
<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="geo.region" content="BR-BA" />
  <meta name="geo.placename" content="Salvador, Bahia" />
  <meta name="geo.position" content="-12.988500;-38.479000" />
  <meta name="ICBM" content="-12.988500;-38.479000" />
  <meta name="robots" content="index, follow" />
  <meta name="revisit" content="7 Days" />
  <meta name="language" content="pt" />
  <meta name="author" content="Fernando Almeida">
  
  <title>Customizando Os Logs Do Rails Para Análise - Desenvolvimento de Software</title>
  
  <meta name="description" content="Formatar os logs da aplicação para simplificar o parsing será nosso principal objetivo nesse post, esta é a primeira etapa de um outro objetivo que é &hellip;">
  
  <link rel="shortcut icon" href="/assets/ico/favicon.png">
  
  <!-- Bootstrap core CSS -->
  <link href="/assets/css/bootstrap.css" rel="stylesheet">
  <link href="/assets/css/font-awesome.min.css" rel="stylesheet">
  <link href="/assets/css/font-mfizz.css" rel="stylesheet">

  <!-- Pygments styles for code blocks -->
  <link href="/assets/css/pygments.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="/assets/css/main.css" rel="stylesheet">

  
  <link rel="canonical" href="http://www.fernandoalmeida.net/blog/customizando-os-logs-do-rails-para-analise">

  <link href="/atom.xml" rel="alternate" title="Desenvolvimento de Software" type="application/atom+xml">

  <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!--[if lt IE 9]>
  <script src="/assets/js/html5shiv.js"></script>
  <script src="/assets/js/respond.min.js"></script>
  <![endif]-->

  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/assets/js/jquery-1.10.2.min.js"></script>
  <script src="/javascripts/delicious.js"></script>
  <script src="/javascripts/github.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/assets/js/bootstrap.min.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10356909-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = '/assets/js/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>
<body   >
  <nav role="navigation"><!-- Fixed navbar -->
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
	<img src="/assets/img/logo_fernando_almeida.png">
      </a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li class=""><a href="/">INÍCIO</a></li>
        <li class=""><a href="/portfolio/">PORTFOLIO</a></li>
        <li class="active"><a href="/blog/">BLOG</a></li>
        <li class=""><a href="/sobre-mim/">SOBRE MIM</a></li>
        <li class=""><a title="CONTATO" data-toggle="modal" data-target="#myModal" href="#myModal"><i class="fa fa-envelope-o"></i></a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div></nav>
  
  <div id="main" class="container w">
    <div id="content">
      <div class="row">
  <div class="col-lg-8">
    <article class="hentry" role="article">
      
  <header>
    
      <h1 class="entry-title">Customizando Os Logs Do Rails Para Análise</h1>
    
    
  </header>


<div class="entry-content"><p>Formatar os logs da aplicação para simplificar o parsing será nosso principal objetivo nesse post, esta é a primeira etapa de um outro objetivo que é centralizar e analisar programaticamente esses logs para identificar eventos e aplicar ações como indexar, arquivar, notificar (por email/group chat) ou simplesmente delegar para outras ferramentas como bug tracker, dashboard de estatísticas (técnicas e/ou de negócio), etc.</p>

<!--more-->


<p>O log padrão do Rails é feito em múltiplas linhas, o que facilita a leitura direta durante o desenvolvimento mas dificulta o parsing.</p>

<p>A <a href="http://docs.fluentd.org/articles/in_tail">documentação do Fluentd</a> exemplifica o parsing multiline de um GET padrão do Rails mas basta acontecer qualquer coisa diferente do “normal” (como um warning ou exception com backtrace) que a regex é rapidamente invalidada.
Para superar essa dificuldade vamos logar cada request em uma única linha e além disso adicionar informações para contextualizar o conteúdo de acordo com a nossa necessidade.</p>

<p>Existem diversas <a href="https://www.ruby-toolbox.com/categories/Logging">ferramentas para customizar os logs do Rails</a>, depois de testar algumas escolhi a gem <a href="https://github.com/roidrage/lograge">Lograge</a> para nos ajudar neste ponto.</p>

<p>A primeira coisa a fazer é instalar e configurar a gem:</p>

<figure class='code'><figcaption><span>Gemfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="err">“</span><span class="n">lograge</span><span class="err">”</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/application.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">log_level</span> <span class="ss">:info</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">lograge</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Com isso já temos um log bem mais fácil de parsear:</p>

<pre><code>method=GET path=/ format=html controller=site action=index status=200 duration=262.28 view=108.93 db=3.84
</code></pre>

<p>Vamos ainda extrair mais algumas informações dos nossos objetos “request“ e “session” criando o módulo CustomLog::ControllerHelper:</p>

<figure class='code'><figcaption><span>lib/custom_log/controller_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ControllerHelper</span>
</span><span class='line'>    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>    <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">append_info_to_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>        <span class="n">payload</span><span class="o">[</span><span class="ss">:request</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span>
</span><span class='line'>        <span class="n">payload</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span> <span class="o">=</span> <span class="n">session</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Incluiremos esse módulo em nosso ApplicationController:</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">CustomLog</span><span class="o">::</span><span class="no">ControllerHelper</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Agora temos a possibilidade de extrair as informações que desejamos, faremos isso criando a classe CustomLog::Subscriber:</p>

<figure class='code'><figcaption><span>lib/custom_log/subscriber.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Subscriber</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:event</span><span class="p">,</span> <span class="ss">:payload</span>
</span><span class='line'>    <span class="kp">attr_accessor</span> <span class="ss">:data</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@event</span> <span class="o">=</span> <span class="n">event</span>
</span><span class='line'>      <span class="vi">@payload</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">payload</span>
</span><span class='line'>      <span class="vi">@data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:time</span> <span class="o">=&gt;</span> <span class="sx">%Q(‘</span><span class="si">#{</span><span class="n">event</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="sx">’)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">extract_data</span>
</span><span class='line'>      <span class="n">session_data</span>
</span><span class='line'>      <span class="n">request_data</span>
</span><span class='line'>      <span class="n">params_data</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">data</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">session_data</span>
</span><span class='line'>      <span class="n">session</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">session</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">merge!</span><span class="p">({</span> <span class="ss">:session_id</span> <span class="o">=&gt;</span> <span class="n">session</span><span class="o">[</span><span class="ss">:session_id</span><span class="o">]</span> <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">request_data</span>
</span><span class='line'>      <span class="n">request</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:request</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">request</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">merge!</span><span class="p">({</span>
</span><span class='line'>          <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:request_id</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:remote_ip</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:user_agent</span> <span class="o">=&gt;</span> <span class="sx">%Q(‘</span><span class="si">#{</span><span class="n">request</span><span class="o">.</span><span class="n">user_agent</span><span class="si">}</span><span class="sx">’)</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:referer</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">referer</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:flash</span> <span class="o">=&gt;</span> <span class="n">request</span><span class="o">.</span><span class="n">flash</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="err">‘</span><span class="vi">@flashes</span><span class="err">’</span><span class="p">)</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">params_data</span>
</span><span class='line'>      <span class="n">internal_params</span> <span class="o">=</span> <span class="sx">%w(controller action format</span>
</span><span class='line'><span class="sx">                           utf8 authenticity_token commit)</span>
</span><span class='line'>      <span class="n">params</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:params</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">params</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">merge!</span><span class="p">({</span> <span class="ss">:params</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">.</span><span class="n">except</span><span class="p">(</span><span class="o">*</span><span class="n">internal_params</span><span class="p">)</span> <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Configuramos também a gem “lograge” para usar nossa classe:</p>

<figure class='code'><figcaption><span>config/environments/development.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">lograge</span><span class="o">.</span><span class="n">custom_options</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
</span><span class='line'>  <span class="no">CustomLog</span><span class="o">::</span><span class="no">Subscriber</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="o">.</span><span class="n">extract_data</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Agora complementamos nosso log com:</p>

<pre><code>time=’2014-06-15 13:13:47 -0300' session_id=abcde12345 host=app01 request_id=a1b2c3d4e5 remote_ip=179.209.205.143 user_agent=’Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:26.0) Gecko/20100101 Firefox/26.0' referer=/things/new flash={:notice=&gt;”Dados gravados com sucesso”} params={“thing”=&gt;{“name”=&gt;”Teste”}
</code></pre>

<p>Além disso vamos incluir também as mensagens de validação do objeto que estamos manipulando, para isso vamos alterar o helper e o subscriber:</p>

<figure class='code'><figcaption><span>lib/custom_log/controller_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ControllerHelper</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">validation_messages</span>
</span><span class='line'>      <span class="n">saved_object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">to_json</span> <span class="k">unless</span> <span class="n">saved_object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">blank?</span>
</span><span class='line'>    <span class="k">rescue</span>
</span><span class='line'>      <span class="kp">nil</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">saved_object</span>
</span><span class='line'>      <span class="nb">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="n">controller_name</span><span class="o">.</span><span class="n">singularize</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">append_info_to_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="n">payload</span><span class="o">[</span><span class="ss">:validations</span><span class="o">]</span> <span class="o">=</span> <span class="n">validation_messages</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>lib/custom_log/subscriber.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Subscriber</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">extract_data</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="n">validations_data</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">validations_data</span>
</span><span class='line'>      <span class="n">validations</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:validations</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">validations</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">merge!</span><span class="p">({</span> <span class="ss">:validations</span> <span class="o">=&gt;</span> <span class="n">validations</span> <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>complementando o log com coisas do tipo:</p>

<pre><code>flash={:error=&gt;”Não foi possível gravar os dados”} validations={"name":["já está em uso"]}
</code></pre>

<p>Em uma aplicação multitenant também é importante ter informações sobre o usuário e o tenant (empresa, conta, etc) com que os requests estão interagindo, para isso alteramos mais uma vez o helper e o subscriber:</p>

<figure class='code'><figcaption><span>lib/custom_log/controller_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ControllerHelper</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">custom_log_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>      <span class="n">payload</span><span class="o">[</span><span class="ss">:custom_log_data</span><span class="o">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">append_info_to_payload</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="n">custom_log_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span>lib/custom_log/subscriber.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Subscriber</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">extract_data</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="n">custom_data</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">custom_data</span>
</span><span class='line'>      <span class="n">custom</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:custom_log_data</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">custom</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
</span><span class='line'>        <span class="n">custom</span><span class="o">.</span><span class="n">each_pair</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="n">data</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Como essas informações são específicas de cada aplicação precisamos customizar o método em nosso controller:</p>

<figure class='code'><figcaption><span>app/controllers/application_controller.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">custom_log_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</span><span class='line'>  <span class="n">payload</span><span class="o">[</span><span class="ss">:custom_log_data</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">user_id</span><span class="p">:</span> <span class="n">current_user</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:id</span><span class="p">),</span>
</span><span class='line'>    <span class="n">account_id</span><span class="p">:</span> <span class="n">current_account</span><span class="o">.</span><span class="n">try</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Dessa forma complementamos nosso log com:</p>

<pre><code>user_id=987 account_id=123
</code></pre>

<p>E para finalizar vamos logar o backtrace completo em caso de exceptions, para isso vamos complementar o <a href="https://github.com/rails/rails/blob/3-2-stable/activesupport/lib/active_support/notifications/instrumenter.rb">Instrumenter do ActiveSupport</a>:</p>

<figure class='code'><figcaption><span>config/initializers/log_backtrace.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActiveSupport</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Notifications</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Instrumenter</span>
</span><span class='line'>      <span class="kp">attr_reader</span> <span class="ss">:id</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
</span><span class='line'>        <span class="vi">@id</span> <span class="o">=</span> <span class="n">unique_id</span>
</span><span class='line'>        <span class="vi">@notifier</span> <span class="o">=</span> <span class="n">notifier</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>        <span class="n">started</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span>
</span><span class='line'>        <span class="k">begin</span>
</span><span class='line'>          <span class="k">yield</span>
</span><span class='line'>        <span class="k">rescue</span> <span class="no">Exception</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>          <span class="n">payload</span><span class="o">[</span><span class="ss">:exception</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="o">]</span>
</span><span class='line'>          <span class="n">payload</span><span class="o">[</span><span class="ss">:backtrace</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">backtrace</span>
</span><span class='line'>          <span class="k">raise</span> <span class="n">e</span>
</span><span class='line'>        <span class="k">ensure</span>
</span><span class='line'>          <span class="vi">@notifier</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">started</span><span class="p">,</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="vi">@id</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>e alterar novamente nosso subscriber:</p>

<figure class='code'><figcaption><span>lib/custom_log/subscriber.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">CustomLog</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Subscriber</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">extract_data</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>      <span class="n">exception_data</span>
</span><span class='line'>      <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">exception_data</span>
</span><span class='line'>      <span class="n">exception</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:exception</span><span class="o">]</span>
</span><span class='line'>      <span class="n">backtrace</span> <span class="o">=</span> <span class="n">payload</span><span class="o">[</span><span class="ss">:backtrace</span><span class="o">]</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">exception</span>
</span><span class='line'>        <span class="n">data</span><span class="o">.</span><span class="n">merge!</span><span class="p">({</span>
</span><span class='line'>          <span class="ss">:exception_class</span> <span class="o">=&gt;</span> <span class="n">exception</span><span class="o">.</span><span class="n">first</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:exception_message</span> <span class="o">=&gt;</span> <span class="n">exception</span><span class="o">.</span><span class="n">last</span><span class="p">,</span>
</span><span class='line'>          <span class="ss">:backtrace</span> <span class="o">=&gt;</span> <span class="sx">%Q(‘</span><span class="si">#{</span><span class="nb">Array</span><span class="p">(</span><span class="n">backtrace</span><span class="p">)</span><span class="o">.</span><span class="n">to_json</span><span class="si">}</span><span class="sx">’)</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Isso adiciona ao  nosso log informações como:</p>

<pre><code>exception_class=RuntimeError exception_message=Test backtrace=’[“complete", "backtrace", "array"]'
</code></pre>

<p>Com isso atingimos nosso objetivo que é ter o log em uma única linha contextualizado com todas as informações que nos interessam para fazer análise de forma automatizada.</p>

<p>Por precaução fiz um benchmark bem  simples com o antes/depois de nossas customizações e a diferença foi de 0.01 segundo simulando 1000 requests com concorrência de 30, o que acredito ser aceitável para a maioria dos casos.</p>

<p>Veja um <a href="https://gist.github.com/fernandoalmeida/ef03643fd8d924cc034a">Gist com o conteúdo completo</a> de cada arquivo que criamos aqui.</p>

<p>Na próxima etapa vamos usar um agregador para receber esses logs customizados, parsear  e tomar decisões sobre onde persistir, arquivar, indexar, notificar, disponibilizar para outros serviços (via <a href="http://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">PubSub</a>, webhook, etc) totalmente independente/desacoplado da aplicação e tolerante a falhas.</p>

<p><strong>Referências e links relacionados:</strong></p>

<ul>
<li><a href="http://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying">http://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying</a></li>
<li><a href="http://gojko.net/2006/12/09/logging-anti-patterns/">http://gojko.net/2006/12/09/logging-anti-patterns/</a></li>
<li><a href="http://blog.mmlac.com/log4r-for-rails/">http://blog.mmlac.com/log4r-for-rails/</a></li>
<li><a href="http://rubyjunky.com/cleaning-up-rails-4-production-logging.html">http://rubyjunky.com/cleaning-up-rails-4-production-logging.html</a></li>
<li><a href="http://www.paperplanes.de/2012/3/14/on-notifications-logsubscribers-and-bringing-sanity-to-rails-logging.html">http://www.paperplanes.de/2012/3/14/on-notifications-logsubscribers-and-bringing-sanity-to-rails-logging.html</a></li>
<li><a href="http://www.railsonmaui.com//blog/2013/05/08/strategies-for-rails-logging-and-error-handling/">http://www.railsonmaui.com//blog/2013/05/08/strategies-for-rails-logging-and-error-handling/</a></li>
<li><a href="http://edgeguides.rubyonrails.org/active_support_instrumentation.html">http://edgeguides.rubyonrails.org/active_support_instrumentation.html</a></li>
</ul>

</div>


      <footer>
	<p class="meta">
	  
  

<span class="byline author vcard"><span class="glyphicon glyphicon-user"></span><span class="fn">Fernando Almeida</span></span>

	  








  


<time datetime="2014-06-22T02:04:51-03:00" pubdate data-updated="true"><span class="glyphicon glyphicon-calendar"></span>22/06/2014</time>
	  

<span class="categories">
  <span class="glyphicon glyphicon-tags"></span>
  
    <a class='category' href='/blog/categories/log/'>log</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


	</p>
	
	<div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://www.fernandoalmeida.net/blog/customizando-os-logs-do-rails-para-analise/" data-via="fernandoalmeida" data-counturl="http://www.fernandoalmeida.net/blog/customizando-os-logs-do-rails-para-analise/" >Tweet</a>
  
  
  
</div>

	
      </footer>
    </article>
    
    <section>
      <h1>Comentários</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
  </div>
  <div class="col-lg-4">
    
    <aside class="sidebar">
      
      <section>
  <h1>Posts Recentes</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/como-usar-postgres-local-sem-senha/">Como Usar Postgres Local Sem Senha</a>
      </li>
    
      <li class="post">
        <a href="/blog/customizando-os-logs-do-rails-para-analise/">Customizando Os Logs Do Rails Para Análise</a>
      </li>
    
      <li class="post">
        <a href="/blog/geral/livros-que-eu-ja-li">Livros Que Eu Já Li</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Delicious</h1>
  <div id="delicious"></div>
  <script type="text/javascript" src="http://feeds.delicious.com/v2/json/fernandoalmeida?count=5&amp;sort=date&amp;callback=renderDeliciousLinks"></script>
</section>

<section>
  <h1>GitHub</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'fernandoalmeida',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


      
    </aside>
    
  </div>
</div>

    </div>
  </div>
  <footer role="contentinfo"><!-- FOOTER -->
<div id="f">
  <div class="container">
    <div class="row centered">
      <a href="http://linkedin.com/in/fernandoalmeida" target="_blank"><i class="fa fa-linkedin"></i></a>
      <a href="https://github.com/fernandoalmeida" target="_blank"><i class="fa fa-github"></i></a>
      <a href="http://stackoverflow.com/users/756704/fernando-almeida" target="_blank"><i class="fa fa-stack-overflow"></i></a>
      <a href="http://rubygems.org/profiles/fernandoalmeida" target="_blank"><i class="icon-ruby"></i></a>
      <a href="https://twitter.com/fernandoalmeida" target="_blank"><i class="fa fa-twitter"></i></a>
      <a href="https://www.facebook.com/fernandoalmeida.net" target="_blank"><i class="fa fa-facebook"></i></a>
      <a href="http://flickr.com/fapontonet" target="_blank"><i class="fa fa-flickr"></i></a>
    </div><!-- row -->
  </div><!-- container -->
</div><!-- Footer -->
</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'fernandoalmeidanet';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.fernandoalmeida.net/blog/customizando-os-logs-do-rails-para-analise/';
        var disqus_url = 'http://www.fernandoalmeida.net/blog/customizando-os-logs-do-rails-para-analise/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<div id="myModal" class="modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
	<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
	<h4 id="myModalLabel" class="modal-title">Contatos</h4>
      </div>
      <div class="modal-body">
	<div class="row centered">
	  <p>
	    Email: <strong>fernando@fernandoalmeida.net</strong><br>
	    Skype: <strong>fernandoalmeida.net</strong><br>
	    Tel: <strong>(11) 99965-8127</strong>
	  </p>
	</div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>
</body>
